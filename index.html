<!DOCTYPE html>
<html>
    <head>
        <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>
    <body>
        <div id="main" class="dropdown-container">
            <h3>This is my first widget.</h3>
            <h3>NOT BHEDDD! GOOD SOIZEEE!</h3>
            <span id="labelText"></span>
        <input type="text" id="sourcePostCode" class="form-textbox" value="">
            <select class="form-dropdown" id="dynamicOptionDropdown">
      </select>
        </div>
<script type="text/javascript">
      JFCustomWidgetUtils.domReady(function () {
        
        
        function DynamicOptionsDropdown() {
          const params = JFCustomWidget.getWidgetSettings();
          const delimiter =
            JFCustomWidget.getWidgetSetting("delimiter") ?? ", ";
          const placeholder =
            JFCustomWidget.getWidgetSetting("placeholder") ?? "";
          const sourceField = JFCustomWidget.getWidgetSetting("sourceField");
          const selectElement = document.getElementById(
              "dynamicOptionDropdown",
            );
          const targetField = JFCustomWidget.getWidgetSetting("targetField");

          const inputFieldSelect = document.getElementById("dynamicOptionDropdown");
          let currentSourceValue;

        inputFieldSelect.addEventListener("change", function(event){
          console.log("inputFieldSelectChange", event);
           JFCustomWidget.sendData(getData());
          // const payload = [
          //   {label: targetField, value: event.target.value}
          // ];
          // JFCustomWidget.setFieldsValueByLabel(payload)
          const value_ = event.target.value
          console.log({value_, targetField});
          // JFCustomWidget.sendCalcValue({value: value_});
          // JotForm.ignoreInsertionCondition = false;
          JFCustomWidget.storeToField(value_, targetField, function(value) {
                console.log("Successfully store field to :", targetField, value);
          });
          const keyUpEvent = new KeyboardEvent('keyup', {
            key: 'Tab',
            keyCode: 9,
            code: 'Tab',
            which: 9,
            bubbles: true,
            cancelable: true
          });
          
          const data = {
            type: 'keyup',
            key: keyUpEvent.key,
            keyCode: keyUpEvent.keyCode,
            code: keyUpEvent.code,
            which: keyUpEvent.which
          };
          window.top.postMessage(data, '*');
          window.parent.postMessage(data, '*');
          // window.parent.postMessage({ action: 'population-completed' }, '*');
        })
      
          JFCustomWidget.listenFromField(sourceField, 'change', function(value) {
            console.log("change", {value});

            console.log({currentSourceValue});

            if(value === currentSourceValue){
              return
            }
            currentSourceValue = value;
            handlePopulateEvent(value);
            
          });
          
          this.getData = getData;
          this.init = init;
          this.handlePopulateEvent = handlePopulateEvent;
          this.selectElement = selectElement;

          function init() {
            // if(placeholder){
            //   const defaultOption = document.createElement("option");
            //   defaultOption.value = "";
            //   defaultOption.textContent = placeholder;
            //   selectElement.appendChild(defaultOption);
            //   defaultOption.selected = true;
            // }
          }

          function handlePopulateEvent(populateEventData) {
            console.log("handlePopulateEvent");
            if(!populateEventData){return}

            console.log({populateEventData});

            const docFragment = document.createDocumentFragment();
            const splitValues = populateEventData.split(delimiter);

            document.querySelectorAll('#dynamicOptionDropdown option').forEach(option => option.remove())

            // let defaultOption
            // if(placeholder){
            //   defaultOption = document.createElement("option");
            //   defaultOption.value = "";
            //   defaultOption.textContent = placeholder;
            //   defaultOption.selected = true;
            //   selectElement.appendChild(defaultOption);
            // }
            if (Array.isArray(splitValues)) {
              splitValues.forEach((optionText) => {
                const option = document.createElement("option");
                option.value = optionText;
                option.textContent = optionText;
                docFragment.appendChild(option);
              });

              selectElement.appendChild(docFragment);
            }
          }

          function getData() {
            console.log("getData");
            console.log(selectElement.value);
            return {
              valid: true,
              value: selectElement.value,
            };
          }
        }

        JFCustomWidget.subscribe("ready", function (data) {
          var widget = new DynamicOptionsDropdown();
          widget.init();

          JFCustomWidget.subscribe("submit", function () {
            JFCustomWidget.sendSubmit(widget.getData());
          });

          // JFCustomWidget.subscribe("populate", function (data) {
          //   widget.handlePopulateEvent(data.value);
          // });
        });
      });
    </script>
    </body>
</html>
