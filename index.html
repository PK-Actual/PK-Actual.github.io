<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>API Data Fetcher Widget with OAuth</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
    }
    input {
      width: 100%;
      margin-bottom: 10px;
      padding: 5px;
    }
  </style>
<body>
  <p>Hello World!</p>
</body>
  
  <script>
    // Manifest for Jotform widget builder (not used at runtime)
    const manifest = {
      name: "API Data Fetcher with OAuth",
      description: "Fetches data from OAuth API and updates inputs.",
      icon: "https://cdn.jotfor.ms/assets/imgs/w-icon.png",
      fields: [],
      js_files: [],
      css_files: [],
      height: 220,
      sandbox: true
    };
    
    if (typeof window !== "undefined" && window.parent && window.parent.setManifest) {
      window.parent.setManifest(manifest);
    }

    window.addEventListener("DOMContentLoaded", () => {
        console.log("DOM Loaded - Code executed!")
      // Build UI
      const container = document.createElement("div");
      container.innerHTML = `
        <label>Name: <input type="text" id="nameField" /></label><br/>
        <label>Email: <input type="text" id="emailField" /></label><br/>
        <label>Status: <input type="text" id="statusField" /></label>
      `;
      document.body.appendChild(container);

      // Update Jotform field values
      function updateFormValue() {
        const value = {
          name: document.getElementById("nameField").value,
          email: document.getElementById("emailField").value,
          status: document.getElementById("statusField").value
        };
        if (window.JFCustomWidget) {
          JFCustomWidget.setValue(value);
        }
      }

      // OAuth client credentials
      const client_id = "24ad82cb-296e-4092-bd81-1a38f31a92a3";       // <-- Replace here
      const client_secret = "7ywL-l0Zf7gK3oDjGe0McvXCrXHKhYr-R52xY6zvWSQwcD4otUXRsxURdHlSI6ui"; // <-- Replace here
      const token_url = "https://mdm.kings.edu.au/v1/auth/token";  // Replace with actual OAuth token endpoint
      const api_url = "https://mdm.kings.edu.au";           // Replace with actual API endpoint

      // Function to get OAuth token
      async function getToken() {
        const body = new URLSearchParams();
        body.append("grant_type", "client_credentials");
        body.append("client_id", client_id);
        body.append("client_secret", client_secret);

        const response = await fetch(token_url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: body.toString()
        });

        if (!response.ok) {
          throw new Error(`Token request failed: ${response.statusText}`);
        }
        const data = await response.json();
        return data.access_token;
      }

      // Function to fetch user data using the token
      async function fetchUserData(token) {
        const response = await fetch(api_url, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!response.ok) {
          throw new Error(`API request failed: ${response.statusText}`);
        }
        return response.json();
      }

      // Main function to get token then fetch user data
      async function fetchData() {
        try {
          const token = await getToken();
          const userData = await fetchUserData(token);

          // Assuming userData includes name, email, status
          document.getElementById("nameField").value = userData.name || "";
          document.getElementById("emailField").value = userData.email || "";
          document.getElementById("statusField").value = userData.status || "";

          updateFormValue();
        } catch (err) {
          console.error("Fetch error:", err);
          document.getElementById("statusField").value = "Error fetching data";
        }
      }

      // Listen for manual input changes
      ['nameField', 'emailField', 'statusField'].forEach(id => {
        document.getElementById(id).addEventListener("input", updateFormValue);
      });

      fetchData();

      if (window.JFCustomWidget) {
        JFCustomWidget.subscribe("ready", () => {
          JFCustomWidget.setHeight(220);
        });
      }
    });

  </script>
</head>
</html>
