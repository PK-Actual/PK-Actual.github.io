<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>API Data Fetcher Widget with OAuth</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
    }
    input {
      width: 100%;
      margin-bottom: 10px;
      padding: 5px;
    }
  </style>
<body>
</body>

<script type="text/javascript">
    JFCustomWidgetUtils.domReady(function () {

        function testWidget() {

            // Global variables
            const client_id = JFCustomWidget.getWidgetSetting('client_id');
            const client_secret = JFCustomWidget.getWidgetSetting('client_secret');
            const token_url = "https://mdm.kings.edu.au/api/v1/auth/token"; // Jamf token creation endpoint
            const api_url = "https://mdm.kings.edu.au/JSSResource/sites"; // Data we want to access via the API

            this.getData = getData;
            this.init = init;

            function getAuthToken(){
                const body = new URLSearchParams();
                body.append("grant_type", "client_credentials");
                body.append("client_id", client_id);
                body.append("client_secret", client_secret);

                fetch(token_url, {
                    mode: 'cors',
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded", 
                        "accept": "application/json" 
                    },
                    body: body.toString()
                }).then((data) => {
                    var jsonResponse = data.json();
                    jsonResponse.then((response) => {
                        if(response.status === 200 && response.result === true){
                            console.log("GREAT SUCCESS!");
                            return true;
                        } else {
                            console.log("KING OF THE CASTLE");
                            return false;
                        }
                    })
                });
            }

            function init(widgetSettings) {
                console.log("hello world", {widgetSettings});
                console.log({params})
            }

            function getData() {
                return {
                    valid: true,
                    value: ""
                };
            }
        }

        JFCustomWidget.subscribe("ready", function (data) {
            var widget = new testWidget();
            widget.init(data);
            console.log(widget.getAuthToken());

            JFCustomWidget.subscribe("submit", function () {
                JFCustomWidget.sendSubmit(widget.getData());
            });
        });
    });
</script>


</head>
</html>
